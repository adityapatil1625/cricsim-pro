name: Code Quality & Dependencies

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Dependency check frontend
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install and audit
      run: |
        npm ci
        npm audit --audit-level=moderate
      continue-on-error: true
    
    - name: Check for outdated packages
      run: npm outdated
      continue-on-error: true
    
    - name: Dependency check server
      working-directory: ./server
      run: |
        npm ci
        npm audit --audit-level=moderate
      continue-on-error: true

  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check for common issues
      run: |
        # Check for console.log statements (should use logger)
        if grep -r "console\." --include="*.js" --include="*.jsx" src/ server/ --exclude-dir=node_modules | grep -v "console.error"; then
          echo "⚠️  Found console statements - consider using logger instead"
        fi
        
        # Check for TODO comments
        if grep -r "TODO\|FIXME\|HACK" --include="*.js" --include="*.jsx" src/ server/ | head -10; then
          echo "⚠️  Found TODO/FIXME comments"
        fi
        
        # Check for magic numbers
        if grep -r "[0-9]\{4,\}" --include="*.js" --include="*.jsx" src/ | grep -v "version\|year\|port\|timestamp" | head -5; then
          echo "⚠️  Found potential magic numbers"
        fi
      continue-on-error: true

  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for documentation
      run: |
        # Check if main files have JSDoc
        echo "Checking for JSDoc in key files..."
        
        MISSING_DOCS=0
        
        # Check React components
        for file in src/hooks/*.js src/utils/*.js; do
          if [ -f "$file" ]; then
            if ! grep -q "@fileoverview\|@module" "$file"; then
              echo "⚠️  Missing module documentation in $file"
              MISSING_DOCS=$((MISSING_DOCS+1))
            fi
          fi
        done
        
        # Check API endpoints
        for file in server/controllers/*.js; do
          if [ -f "$file" ]; then
            if ! grep -q "@fileoverview\|@description" "$file"; then
              echo "⚠️  Missing documentation in $file"
              MISSING_DOCS=$((MISSING_DOCS+1))
            fi
          fi
        done
        
        echo "Found $MISSING_DOCS files with incomplete documentation"
      continue-on-error: true
    
    - name: Verify README is up to date
      run: |
        if [ ! -f "README.md" ]; then
          echo "❌ README.md is missing"
          exit 1
        fi
        
        # Check for essential sections
        REQUIRED_SECTIONS=("Installation" "Getting Started" "Features" "Architecture" "Contributing")
        for section in "${REQUIRED_SECTIONS[@]}"; do
          if ! grep -q "^## $section\|^# $section" README.md; then
            echo "⚠️  README missing section: $section"
          fi
        done
      continue-on-error: true

  performance:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Analyze bundle
      run: |
        npm run build
        
        echo "Build artifacts:"
        du -sh dist/
        ls -lh dist/
        
        # Check for large files
        echo "Files larger than 100KB:"
        find dist -type f -size +100k
      continue-on-error: true

  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Validate configuration files
      run: |
        echo "Checking configuration files..."
        
        # Validate package.json
        if [ -f "package.json" ]; then
          node -e "JSON.parse(require('fs').readFileSync('package.json'))" && echo "✅ package.json is valid"
        fi
        
        # Validate vite.config.js
        if [ -f "vite.config.js" ]; then
          node -c vite.config.js && echo "✅ vite.config.js is valid"
        fi
        
        # Validate vitest.config.js
        if [ -f "vitest.config.js" ]; then
          node -c vitest.config.js && echo "✅ vitest.config.js is valid"
        fi
        
        # Check .env.example exists
        if [ ! -f ".env.example" ]; then
          echo "⚠️  .env.example is missing"
        fi
      continue-on-error: true
